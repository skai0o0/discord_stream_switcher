<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Discord Stream Switcher ‚Ä¢ Dashboard (GRID-last)</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <nav>
      <div class="navbar-left">
        <div class="navbar-logo">üéÆ Discord Stream Switcher ‚Ä¢ Dashboard</div>
        <div class="muted">(Canvas preview ‚Äì d√πng localhost ·ªü m√°y c·ªßa b·∫°n ƒë·ªÉ ch·∫°y th·ª±c)</div>
      </div>
      <div class="navbar-right">
        <button class="navbar-btn theme-btn" id="themeToggle" title="Toggle theme">
          <svg class="sun-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 4V2M12 22v-2M4.93 4.93L3.52 3.52M20.48 20.48l-1.41-1.41M4 12H2m20 0h-2M4.93 19.07l-1.41 1.41M20.48 3.52l-1.41 1.41" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2"/></svg>
          <svg class="moon-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2" fill="currentColor"/></svg>
        </button>
      </div>
    </nav>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <div class="body">
          <h3>1) K·∫øt n·ªëi & Ki·ªÉm tra</h3>
          <div class="row" style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; align-items:center">
            <button class="btn" onclick="testHealth()">Health</button>
            <button class="btn" onclick="testDiscord()">Discord Status</button>
          </div>
          <div class="stat">
            <div class="box"><div class="val" id="statStreams">0</div><div class="lbl">Active Streams</div></div>
            <div class="box"><div class="val" id="statCurrent">-</div><div class="lbl">Current Index</div></div>
            <div class="box"><div class="val" id="statServer">‚Äì</div><div class="lbl">Server</div></div>
          </div>
          <p class="muted" style="margin-top:10px">Server m·∫∑c ƒë·ªãnh: <span class="inline-code" id="serverUrlLbl">http://localhost:3333</span></p>
        </div>
      </section>

      <section class="card">
        <div class="body">
          <h3>2) Copy Script ƒë·ªÉ d√°n v√†o Discord (Console)</h3>
          <p class="muted">B1: M·ªü Discord ·ªü debug mode ‚Üí B2: <span class="inline-code">chrome://inspect/#devices</span> ‚Üí Inspect tab Discord ‚Üí Console ‚Üí Paste script.</p>
          <div class="row" style="margin:8px 0 12px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn" onclick="copyTestSnippet()">üìã Copy Test Snippet</button>
            <button class="btn btn-primary" onclick="copyMainScript()">üìã Copy Main Script</button>
          </div>
          <details>
            <summary class="muted">Xem nhanh l·ªánh m·ªü Discord debug</summary>
            <div class="mono" style="margin-top:8px">%LocalAppData%\Discord\Update.exe --processStart Discord.exe --process-start-args="--remote-debugging-port=9222"</div>
          </details>
        </div>
      </section>

      <section class="card" style="grid-column:1/-1">
        <div class="body">
          <h3>3) Stream Grid</h3>
          <div class="row" style="margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn" onclick="refreshStreams()">Refresh Streams</button>
            <button class="btn" onclick="prevStream()">‚¨Ö Previous</button>
            <button class="btn" onclick="nextStream()">Next ‚û°</button>
          </div>
          <div class="streams" id="grid"></div>
        </div>
      </section>

      <section class="card" style="grid-column:1/-1">
        <div class="body">
          <h3>4) Self Tests</h3>
          <div class="row" style="margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn" onclick="runSelfTests()">‚ñ∂ Run Self Tests</button>
          </div>
          <div class="test" id="testOut"></div>
        </div>
      </section>

      <section class="card" style="grid-column:1/-1">
        <div class="body">
          <h3>Logs</h3>
          <div class="log" id="log"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- ===== Templates: script snippets to copy ===== -->
  <template id="tpl-test-snippet"><!-- Simple detector (kh√¥ng parse t√™n) -->
const tiles = [...document.querySelectorAll('div[data-selenium-video-tile] .focusTarget__54e4b[role="button"]')];
console.log('üéØ Found video tiles:', tiles.length);
const results = tiles.map((el, i)=>{
  const videoTile = el.closest('[data-selenium-video-tile]');
  const id = videoTile?.dataset?.seleniumVideoTile;
  const name = `Stream ${i+1}`;
  return { id, name };
});
console.log('üìä Streams:', results);
if(!results.length){console.warn('‚ùå No streams found ‚Äì h√£y b·∫≠t Grid + multistream v√† t·∫Øt camera/preview');}
  </template>

  <template id="tpl-main-script"><!-- ========== Main integration: keep GRID (last), dedupe IDs, stable order, Alt hotkeys, no username scraping ========== -->
(function(){'use strict';
  const ORDER_BOOK = new Map(); // id -> slot (·ªïn ƒë·ªãnh)
  let CURRENT_STREAM_IDS = [];   // [{id,name,kind}]
  let CURRENT_STREAM_INDEX = 0;

  function classifyTile(tile){
    const videoCount = tile.querySelectorAll('video, canvas').length;
    const gridLike = tile.querySelector('[class*="grid" i],[class*="gallery" i]');
    return (videoCount >= 2 || gridLike) ? 'grid' : 'individual';
  }

  function scanTiles(){
    const btns = Array.from(document.querySelectorAll('div[data-selenium-video-tile] .focusTarget__54e4b[role="button"]'));
    return btns.map(function(btn, idx){
      const tile = btn.closest('[data-selenium-video-tile]');
      const id = tile && tile.dataset && tile.dataset.seleniumVideoTile;
      if(!id) return null;
      const kind = classifyTile(tile);
      const name = (kind === 'grid') ? 'GRID' : ('Stream ' + (idx+1));
      return { id:id, name:name, kind:kind };
    }).filter(Boolean);
  }

  // Dedupe theo ID: n·∫øu tr√πng gi·ªØa grid & individual ‚Üí gi·ªØ individual; v·∫´n gi·ªØ 1 entry GRID n·∫øu n√≥ c√≥ ID kh√°c
  function dedupePreferIndividual(arr){
    const best = new Map();
    for(const it of arr){
      const prev = best.get(it.id);
      if(!prev){ best.set(it.id, it); continue; }
      if(prev.kind !== 'individual' && it.kind === 'individual') best.set(it.id, it);
    }
    return Array.from(best.values());
  }

  // Th·ª© t·ª± ·ªïn ƒë·ªãnh + ƒë·∫©y GRID xu·ªëng cu·ªëi c√πng
  function stableOrder(entries){
    const used = new Set();
    const placed = [];
    // Gi·ªØ slot c≈©
    entries.forEach(function(e){
      if(ORDER_BOOK.has(e.id)){
        const slot = ORDER_BOOK.get(e.id);
        placed.push({slot:slot, id:e.id, name:e.name, kind:e.kind});
        used.add(slot);
      }
    });
    // ID m·ªõi ‚Üí slot tr·ªëng nh·ªè nh·∫•t (∆∞u ti√™n individual tr∆∞·ªõc grid)
    const newcomers = entries.filter(function(e){return !ORDER_BOOK.has(e.id);}).sort(function(a,b){
      if((a.kind==='individual') === (b.kind==='individual')) return 0; return (a.kind==='individual')? -1 : 1;
    });
    function nextFreeSlot(){ var s=0; while(used.has(s)) s++; used.add(s); return s; }
    newcomers.forEach(function(e){ var slot = nextFreeSlot(); ORDER_BOOK.set(e.id, slot); placed.push({slot:slot, id:e.id, name:e.name, kind:e.kind}); });
    // Sort theo slot nh∆∞ng GRID lu√¥n ·ªü cu·ªëi
    placed.sort(function(a,b){
      if(a.kind==='grid' && b.kind!=='grid') return 1;
      if(b.kind==='grid' && a.kind!=='grid') return -1;
      return a.slot - b.slot;
    });
    return placed.map(function(p){ return {id:p.id, name:p.name, kind:p.kind}; });
  }

  function getCurrentStreamIds(){
    try{
      const raw  = scanTiles();
      const uniq = dedupePreferIndividual(raw);
      const ordered = stableOrder(uniq);
      return ordered;
    }catch(e){ console.error(e); return []; }
  }

  function refreshStreams(){
    CURRENT_STREAM_IDS = getCurrentStreamIds();
    if(CURRENT_STREAM_INDEX >= CURRENT_STREAM_IDS.length) CURRENT_STREAM_INDEX = Math.max(0, CURRENT_STREAM_IDS.length - 1);
    return CURRENT_STREAM_IDS;
  }

  function switchToStreamById(id){
    try{
      const sel = 'div[data-selenium-video-tile="' + CSS.escape(id) + '"] .focusTarget__54e4b[role="button"]';
      const target = document.querySelector(sel);
      if(target){ target.click(); CURRENT_STREAM_INDEX = Math.max(0, CURRENT_STREAM_IDS.findIndex(function(s){ return (s.id||s)===id; })); return true; }
      return false;
    }catch(e){ console.error(e); return false; }
  }

  function switchToStreamByIndex(i){ if(i<0||i>=CURRENT_STREAM_IDS.length) return false; const id=(CURRENT_STREAM_IDS[i].id||CURRENT_STREAM_IDS[i]); return switchToStreamById(id); }
  function switchToNextStream(){ if(!CURRENT_STREAM_IDS.length) refreshStreams(); if(!CURRENT_STREAM_IDS.length) return false; CURRENT_STREAM_INDEX=(CURRENT_STREAM_INDEX+1)%CURRENT_STREAM_IDS.length; return switchToStreamByIndex(CURRENT_STREAM_INDEX); }
  function switchToPreviousStream(){ if(!CURRENT_STREAM_IDS.length) refreshStreams(); if(!CURRENT_STREAM_IDS.length) return false; CURRENT_STREAM_INDEX=(CURRENT_STREAM_INDEX-1+CURRENT_STREAM_IDS.length)%CURRENT_STREAM_IDS.length; return switchToStreamByIndex(CURRENT_STREAM_INDEX); }

  window.DiscordStreamDeck = {
    refreshStreams: refreshStreams,
    switchToStreamById: switchToStreamById,
    switchToStreamByIndex: switchToStreamByIndex,
    switchToNextStream: switchToNextStream,
    switchToPreviousStream: switchToPreviousStream,
    getCurrentStreamIds: getCurrentStreamIds,
    getStatus: function(){ return { streams: CURRENT_STREAM_IDS.length? CURRENT_STREAM_IDS: [], currentIndex: CURRENT_STREAM_INDEX, totalStreams: CURRENT_STREAM_IDS.length }; }
  };

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', function(){ setTimeout(refreshStreams, 2000); });
  } else { setTimeout(refreshStreams, 2000); }

  // Hotkeys: Alt + F1..F9, Alt+‚Üê/‚Üí
  document.addEventListener('keydown', function(e){
    if(e.altKey && /^F[1-9]$/.test(e.key)){ e.preventDefault(); var n=parseInt(e.key.slice(1),10); if(n>=1&&n<=9) switchToStreamByIndex(n-1); }
    if(e.altKey && e.key==='ArrowRight'){ e.preventDefault(); switchToNextStream(); }
    if(e.altKey && e.key==='ArrowLeft'){ e.preventDefault(); switchToPreviousStream(); }
  });
})();
  </template>

  <script src="app.js"></script>
</body>
</html>
