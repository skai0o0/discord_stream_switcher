<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Discord Stream Switcher ‚Ä¢ Dashboard (GRID-last)</title>
  <style>
/* === Theme (light & dark) === */
:root {
  --bg: #ffffff; --bg-soft: #fafbfc; --card: #ffffff; --text: #1a1a1a; --muted: #6b7280;
  --brand: #2563eb; --brand-2: #0ee983; --ok: #059669; --warn: #d97706; --bad: #dc2626;
  --chip: #f8fafc; --table: #fcfcfd; --border: #e5e7eb;
}
[data-theme="dark"] {
  --bg: #0f0f23; --bg-soft: #1a1a2e; --card: #16213e; --text: #e2e8f0; --muted: #94a3b8;
  --brand: #3b82f6; --brand-2: #10b981; --ok: #10b981; --warn: #f59e0b; --bad: #ef4444;
  --chip: #1e293b; --table: #1e293b; --border: #334155;
}
* { box-sizing: border-box; transition: background-color .3s ease, border-color .3s ease, color .3s ease; }
html, body { height:100%; }
body { margin:0; font-family:'Roboto', ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", sans-serif; background: linear-gradient(135deg, rgba(37,99,235,.02) 0%, rgba(14,165,233,.01) 100%), var(--bg); color: var(--text); line-height:1.55; padding-top:60px; }
[data-theme="dark"] body { background: linear-gradient(135deg, rgba(59,130,246,.08) 0%, rgba(16,185,129,.04) 100%), var(--bg); }
header { position:fixed; top:0; left:0; right:0; z-index:1000; border-bottom:1px solid var(--border); background: rgba(255,255,255,.95); backdrop-filter: blur(10px); padding:8px 24px; }
[data-theme="dark"] header { background: rgba(255,255,255,.02); }
nav { display:flex; align-items:center; justify-content:space-between; gap:16px; max-width:1200px; margin:0 auto; }
.navbar-left{display:flex; align-items:center; gap:10px}
.navbar-right{display:flex; align-items:center; gap:8px}
.navbar-logo{ margin:0; font-size:20px; color:var(--brand); font-weight:800; letter-spacing:.2px }
.navbar-btn{ display:flex; align-items:center; justify-content:center; width:40px; height:40px; border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:8px; cursor:pointer }
.theme-btn .sun-icon{display:block}
.theme-btn .moon-icon{display:none}
[data-theme="dark"] .theme-btn .sun-icon{display:none}
[data-theme="dark"] .theme-btn .moon-icon{display:block}
main { max-width:1200px; margin:20px auto; padding:0 18px 80px }
.card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:24px; margin-bottom:24px; box-shadow: 0 1px 3px rgba(0,0,0,.03) }
.grid { display:grid; grid-template-columns:1fr; gap:16px }
@media(min-width:900px){ .grid{ grid-template-columns:1fr 1fr } }
.btn{ border:1px solid var(--border); background:var(--card); color:var(--text); padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600 }
.btn-primary{ background:var(--brand); color:#fff; border-color:var(--brand) }
.inline-code{ background:var(--chip); border:1px solid var(--border); padding:2px 6px; border-radius:6px }
.muted{ color:var(--muted) }
.stat{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:12px; margin-top:12px }
.stat .box{ background:var(--bg-soft); border:1px solid var(--border); border-radius:10px; padding:12px; text-align:center }
.stat .val{ font-weight:800; font-size:22px }
.stat .lbl{ font-size:12px; color:var(--muted) }
.streams{ display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:14px; margin-top:12px }
.tile{ position:relative; border-radius:14px; background:linear-gradient(135deg,var(--brand), var(--brand-2)); padding:16px; cursor:pointer; color:#fff }
.tile.active{ outline:3px solid var(--ok) }
.tile .name{ font-weight:800 }
.tile .id{ font-family:Consolas,monospace; font-size:12px; opacity:.9 }
/* default badge (F1..Fn) */
.tile .badge{ position:absolute; top:8px; right:8px; background:rgba(255,255,255,.25); padding:4px 6px; border-radius:8px; font-size:10px }
/* GRID badge (left) */
.tile .badge.kind{ left:8px; right:auto; background:var(--chip); color:var(--text); border:1px solid var(--border); font-weight:700 }
.log{ height:180px; overflow:auto; background:var(--bg-soft); border:1px solid var(--border); border-radius:10px; padding:10px; font-family:Consolas,monospace }
.test{ height:auto; max-height:220px; overflow:auto; background:var(--bg-soft); border:1px dashed var(--border); border-radius:10px; padding:10px; font-family:Consolas,monospace }
  </style>
</head>
<body>
  <header>
    <nav>
      <div class="navbar-left">
        <div class="navbar-logo">üéÆ Discord Stream Switcher ‚Ä¢ Dashboard</div>
        <div class="muted">(Canvas preview ‚Äì d√πng localhost ·ªü m√°y c·ªßa b·∫°n ƒë·ªÉ ch·∫°y th·ª±c)</div>
      </div>
      <div class="navbar-right">
        <button class="navbar-btn theme-btn" id="themeToggle" title="Toggle theme">
          <svg class="sun-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 4V2M12 22v-2M4.93 4.93L3.52 3.52M20.48 20.48l-1.41-1.41M4 12H2m20 0h-2M4.93 19.07l-1.41 1.41M20.48 3.52l-1.41 1.41" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2"/></svg>
          <svg class="moon-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2" fill="currentColor"/></svg>
        </button>
      </div>
    </nav>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <div class="body">
          <h3>1) K·∫øt n·ªëi & Ki·ªÉm tra</h3>
          <div class="row" style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; align-items:center">
            <button class="btn" onclick="testHealth()">Health</button>
            <button class="btn" onclick="testDiscord()">Discord Status</button>
          </div>
          <div class="stat">
            <div class="box"><div class="val" id="statStreams">0</div><div class="lbl">Active Streams</div></div>
            <div class="box"><div class="val" id="statCurrent">-</div><div class="lbl">Current Index</div></div>
            <div class="box"><div class="val" id="statServer">‚Äì</div><div class="lbl">Server</div></div>
          </div>
          <p class="muted" style="margin-top:10px">Server m·∫∑c ƒë·ªãnh: <span class="inline-code" id="serverUrlLbl">http://localhost:3333</span></p>
        </div>
      </section>

      <section class="card">
        <div class="body">
          <h3>2) Copy Script ƒë·ªÉ d√°n v√†o Discord (Console)</h3>
          <p class="muted">B1: M·ªü Discord ·ªü debug mode ‚Üí B2: <span class="inline-code">chrome://inspect/#devices</span> ‚Üí Inspect tab Discord ‚Üí Console ‚Üí Paste script.</p>
          <div class="row" style="margin:8px 0 12px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn" onclick="copyTestSnippet()">üìã Copy Test Snippet</button>
            <button class="btn btn-primary" onclick="copyMainScript()">üìã Copy Main Script</button>
          </div>
          <details>
            <summary class="muted">Xem nhanh l·ªánh m·ªü Discord debug</summary>
            <div class="mono" style="margin-top:8px">%LocalAppData%\Discord\Update.exe --processStart Discord.exe --process-start-args="--remote-debugging-port=9222"</div>
          </details>
        </div>
      </section>

      <section class="card" style="grid-column:1/-1">
        <div class="body">
          <h3>3) Stream Grid</h3>
          <div class="row" style="margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn" onclick="refreshStreams()">Refresh Streams</button>
            <button class="btn" onclick="prevStream()">‚¨Ö Previous</button>
            <button class="btn" onclick="nextStream()">Next ‚û°</button>
          </div>
          <div class="streams" id="grid"></div>
        </div>
      </section>

      <section class="card" style="grid-column:1/-1">
        <div class="body">
          <h3>4) Self Tests</h3>
          <div class="row" style="margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn" onclick="runSelfTests()">‚ñ∂ Run Self Tests</button>
          </div>
          <div class="test" id="testOut"></div>
        </div>
      </section>

      <section class="card" style="grid-column:1/-1">
        <div class="body">
          <h3>Logs</h3>
          <div class="log" id="log"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- ===== Templates: script snippets to copy ===== -->
  <template id="tpl-test-snippet"><!-- Simple detector (kh√¥ng parse t√™n) -->
const tiles = [...document.querySelectorAll('div[data-selenium-video-tile] .focusTarget__54e4b[role="button"]')];
console.log('üéØ Found video tiles:', tiles.length);
const results = tiles.map((el, i)=>{
  const videoTile = el.closest('[data-selenium-video-tile]');
  const id = videoTile?.dataset?.seleniumVideoTile;
  const name = `Stream ${i+1}`;
  return { id, name };
});
console.log('üìä Streams:', results);
if(!results.length){console.warn('‚ùå No streams found ‚Äì h√£y b·∫≠t Grid + multistream v√† t·∫Øt camera/preview');}
  </template>

  <template id="tpl-main-script"><!-- ========== Main integration: keep GRID (last), dedupe IDs, stable order, Alt hotkeys, no username scraping ========== -->
(function(){'use strict';
  const ORDER_BOOK = new Map(); // id -> slot (·ªïn ƒë·ªãnh)
  let CURRENT_STREAM_IDS = [];   // [{id,name,kind}]
  let CURRENT_STREAM_INDEX = 0;

  function classifyTile(tile){
    const videoCount = tile.querySelectorAll('video, canvas').length;
    const gridLike = tile.querySelector('[class*="grid" i],[class*="gallery" i]');
    return (videoCount >= 2 || gridLike) ? 'grid' : 'individual';
  }

  function scanTiles(){
    const btns = Array.from(document.querySelectorAll('div[data-selenium-video-tile] .focusTarget__54e4b[role="button"]'));
    return btns.map(function(btn, idx){
      const tile = btn.closest('[data-selenium-video-tile]');
      const id = tile && tile.dataset && tile.dataset.seleniumVideoTile;
      if(!id) return null;
      const kind = classifyTile(tile);
      const name = (kind === 'grid') ? 'GRID' : ('Stream ' + (idx+1));
      return { id:id, name:name, kind:kind };
    }).filter(Boolean);
  }

  // Dedupe theo ID: n·∫øu tr√πng gi·ªØa grid & individual ‚Üí gi·ªØ individual; v·∫´n gi·ªØ 1 entry GRID n·∫øu n√≥ c√≥ ID kh√°c
  function dedupePreferIndividual(arr){
    const best = new Map();
    for(const it of arr){
      const prev = best.get(it.id);
      if(!prev){ best.set(it.id, it); continue; }
      if(prev.kind !== 'individual' && it.kind === 'individual') best.set(it.id, it);
    }
    return Array.from(best.values());
  }

  // Th·ª© t·ª± ·ªïn ƒë·ªãnh + ƒë·∫©y GRID xu·ªëng cu·ªëi c√πng
  function stableOrder(entries){
    const used = new Set();
    const placed = [];
    // Gi·ªØ slot c≈©
    entries.forEach(function(e){
      if(ORDER_BOOK.has(e.id)){
        const slot = ORDER_BOOK.get(e.id);
        placed.push({slot:slot, id:e.id, name:e.name, kind:e.kind});
        used.add(slot);
      }
    });
    // ID m·ªõi ‚Üí slot tr·ªëng nh·ªè nh·∫•t (∆∞u ti√™n individual tr∆∞·ªõc grid)
    const newcomers = entries.filter(function(e){return !ORDER_BOOK.has(e.id);}).sort(function(a,b){
      if((a.kind==='individual') === (b.kind==='individual')) return 0; return (a.kind==='individual')? -1 : 1;
    });
    function nextFreeSlot(){ var s=0; while(used.has(s)) s++; used.add(s); return s; }
    newcomers.forEach(function(e){ var slot = nextFreeSlot(); ORDER_BOOK.set(e.id, slot); placed.push({slot:slot, id:e.id, name:e.name, kind:e.kind}); });
    // Sort theo slot nh∆∞ng GRID lu√¥n ·ªü cu·ªëi
    placed.sort(function(a,b){
      if(a.kind==='grid' && b.kind!=='grid') return 1;
      if(b.kind==='grid' && a.kind!=='grid') return -1;
      return a.slot - b.slot;
    });
    return placed.map(function(p){ return {id:p.id, name:p.name, kind:p.kind}; });
  }

  function getCurrentStreamIds(){
    try{
      const raw  = scanTiles();
      const uniq = dedupePreferIndividual(raw);
      const ordered = stableOrder(uniq);
      return ordered;
    }catch(e){ console.error(e); return []; }
  }

  function refreshStreams(){
    CURRENT_STREAM_IDS = getCurrentStreamIds();
    if(CURRENT_STREAM_INDEX >= CURRENT_STREAM_IDS.length) CURRENT_STREAM_INDEX = Math.max(0, CURRENT_STREAM_IDS.length - 1);
    return CURRENT_STREAM_IDS;
  }

  function switchToStreamById(id){
    try{
      const sel = 'div[data-selenium-video-tile="' + CSS.escape(id) + '"] .focusTarget__54e4b[role="button"]';
      const target = document.querySelector(sel);
      if(target){ target.click(); CURRENT_STREAM_INDEX = Math.max(0, CURRENT_STREAM_IDS.findIndex(function(s){ return (s.id||s)===id; })); return true; }
      return false;
    }catch(e){ console.error(e); return false; }
  }

  function switchToStreamByIndex(i){ if(i<0||i>=CURRENT_STREAM_IDS.length) return false; const id=(CURRENT_STREAM_IDS[i].id||CURRENT_STREAM_IDS[i]); return switchToStreamById(id); }
  function switchToNextStream(){ if(!CURRENT_STREAM_IDS.length) refreshStreams(); if(!CURRENT_STREAM_IDS.length) return false; CURRENT_STREAM_INDEX=(CURRENT_STREAM_INDEX+1)%CURRENT_STREAM_IDS.length; return switchToStreamByIndex(CURRENT_STREAM_INDEX); }
  function switchToPreviousStream(){ if(!CURRENT_STREAM_IDS.length) refreshStreams(); if(!CURRENT_STREAM_IDS.length) return false; CURRENT_STREAM_INDEX=(CURRENT_STREAM_INDEX-1+CURRENT_STREAM_IDS.length)%CURRENT_STREAM_IDS.length; return switchToStreamByIndex(CURRENT_STREAM_INDEX); }

  window.DiscordStreamDeck = {
    refreshStreams: refreshStreams,
    switchToStreamById: switchToStreamById,
    switchToStreamByIndex: switchToStreamByIndex,
    switchToNextStream: switchToNextStream,
    switchToPreviousStream: switchToPreviousStream,
    getCurrentStreamIds: getCurrentStreamIds,
    getStatus: function(){ return { streams: CURRENT_STREAM_IDS.length? CURRENT_STREAM_IDS: [], currentIndex: CURRENT_STREAM_INDEX, totalStreams: CURRENT_STREAM_IDS.length }; }
  };

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', function(){ setTimeout(refreshStreams, 2000); });
  } else { setTimeout(refreshStreams, 2000); }

  // Hotkeys: Alt + F1..F9, Alt+‚Üê/‚Üí
  document.addEventListener('keydown', function(e){
    if(e.altKey && /^F[1-9]$/.test(e.key)){ e.preventDefault(); var n=parseInt(e.key.slice(1),10); if(n>=1&&n<=9) switchToStreamByIndex(n-1); }
    if(e.altKey && e.key==='ArrowRight'){ e.preventDefault(); switchToNextStream(); }
    if(e.altKey && e.key==='ArrowLeft'){ e.preventDefault(); switchToPreviousStream(); }
  });
})();
  </template>

  <script>
    // === Theme toggle (persist to localStorage) ===
    (function(){
      const root = document.documentElement;
      const key = 'theme';
      const getSystem = () => window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      const load = () => localStorage.getItem(key) || getSystem();
      const apply = (t) => { root.setAttribute('data-theme', t); };
      let current = load();
      apply(current);
      document.getElementById('themeToggle').addEventListener('click',()=>{
        current = (root.getAttribute('data-theme')==='dark') ? 'light' : 'dark';
        apply(current); localStorage.setItem(key,current);
      });
    })();

    const serverUrl = 'http://localhost:3333';
    const logEl = document.getElementById('log');
    const gridEl = document.getElementById('grid');
    const statStreams = document.getElementById('statStreams');
    const statCurrent = document.getElementById('statCurrent');
    const statServer = document.getElementById('statServer');
    // kh√¥ng d√πng optional chaining ·ªü LHS khi g√°n
    (function(){ const el = document.getElementById('serverUrlLbl'); if(el) el.textContent = serverUrl; })();

    function log(msg){
      const line = document.createElement('div');
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logEl.appendChild(line); logEl.scrollTop = logEl.scrollHeight;
    }

    async function api(path, method='GET', body){
      const res = await fetch(serverUrl + path, {method, headers:{'Content-Type':'application/json'}, body: body?JSON.stringify(body):undefined});
      const j = await res.json(); if(!res.ok) throw new Error(j.error||'API error'); return j;
    }

    async function testHealth(){
      try{ await api('/health'); statServer.textContent = 'OK'; log('Health OK'); }
      catch(e){ statServer.textContent = 'ERR'; log('Health ERR: '+e.message); }
    }
    async function testDiscord(){
      try{ await api('/api/discord/status'); log('Discord: connected'); refreshStreams(); }
      catch(e){ log('Discord: not ready ‚Äì h√£y inject script'); }
    }

    function __renderStreamsTo(container, streams, currentIndex){
      container.innerHTML='';
      if(!streams || !streams.length){ container.innerHTML = '<div class="muted">Ch∆∞a ph√°t hi·ªán stream n√†o. Ki·ªÉm tra Grid view + multistream + t·∫Øt camera/preview.</div>'; return; }
      streams.forEach(function(s,i){
        const btn = document.createElement('button'); btn.className='tile'+(i===currentIndex?' active':'');
        const id = (typeof s==='string'? s : s && s.id);
        const name = (s && s.name) ? s.name : ('Stream ' + (i+1));
        const isGrid = (s && s.kind === 'grid');
        const gridBadge = isGrid ? '<div class="badge kind">GRID</div>' : '';
        btn.innerHTML = gridBadge + '<div class="badge">F'+(i+1)+'</div>'+
          '<div class="name">'+ name +'</div>'+
          '<div class="id">'+ ((id||'').slice(0,8))+'...'+((id||'').slice(-4)) +'</div>';
        btn.onclick = function(){ switchByIndex(i); };
        container.appendChild(btn);
      });
    }

    function renderStreams(streams, currentIndex){ __renderStreamsTo(gridEl, streams, currentIndex); }

    async function refreshStreams(){
      try{ const r = await api('/api/streams/refresh','POST');
        statStreams.textContent = r && r.streams ? r.streams.length : 0;
        statCurrent.textContent = (r && r.streams && r.streams.length) ? (r.currentIndex+1)+'/'+r.streams.length : '-';
        renderStreams(r.streams, r.currentIndex); log('Refreshed streams');
      }catch(e){ log('Refresh ERR: '+e.message); }
    }

    async function switchByIndex(i){
      try{ const r = await api('/api/streams/switch-by-index/'+i,'POST'); log('Switch index '+(i+1)+': '+(r.success?'OK':'FAIL')); refreshStreams(); }
      catch(e){ log('Switch ERR: '+e.message); }
    }
    async function nextStream(){ try{ await api('/api/streams/next','POST'); log('Next'); refreshStreams(); }catch(e){ log('Next ERR: '+e.message);} }
    async function prevStream(){ try{ await api('/api/streams/previous','POST'); log('Previous'); refreshStreams(); }catch(e){ log('Prev ERR: '+e.message);} }

    function copy(text){ navigator.clipboard.writeText(text).then(()=>log('Copied to clipboard')).catch(function(e){log('Copy failed: '+e.message)}); }
    function copyTestSnippet(){ copy(document.getElementById('tpl-test-snippet').textContent.trim()); }
    function copyMainScript(){ copy(document.getElementById('tpl-main-script').textContent.trim()); }

    // ===== Self Tests =====
    function appendTest(out, name, ok, note){
      const line = document.createElement('div');
      line.textContent = (ok ? '‚úÖ' : '‚ùå')+' '+name+(note? ' ‚Äî '+note:'');
      out.appendChild(line);
    }
    async function runSelfTests(){
      const out = document.getElementById('testOut'); out.innerHTML='';
      try{
        // T1: Assign serverUrlLbl OK
        var ok1=false; (function(){ var el=document.createElement('span'); el.id='serverUrlLbl_TEST'; document.body.appendChild(el); try{ var t='http://localhost:3333'; var ref=document.getElementById('serverUrlLbl_TEST'); if(ref) ref.textContent=t; ok1 = (ref.textContent===t); } finally { el.remove(); } })();
        appendTest(out, 'T1: Assign serverUrlLbl', ok1);

        // T2: Render grid + GRID badge
        var temp=document.createElement('div'); __renderStreamsTo(temp, [{id:'AAA111',name:'Stream 1'},{id:'GRID_ID',name:'GRID',kind:'grid'}], 0);
        var ok2 = temp.querySelectorAll('.tile').length===2 && temp.querySelector('.badge.kind')!==null;
        appendTest(out,'T2: GRID badge present', ok2);

        // T3: Template main ch·ª©a DiscordStreamDeck
        var txt = document.getElementById('tpl-main-script').textContent;
        appendTest(out,'T3: Has DiscordStreamDeck', /DiscordStreamDeck/.test(txt));

        appendTest(out,'T4: api() available', typeof api==='function');
        log('Self tests finished');
      }catch(e){ appendTest(out,'Runtime error',false,e.message); console.error(e); }
    }
    window.runSelfTests = runSelfTests;

    // Auto: ping health khi load
    testHealth().catch(function(){});
  </script>
</body>
</html>
